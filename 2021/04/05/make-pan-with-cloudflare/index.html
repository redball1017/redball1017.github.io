<!DOCTYPE html>

<html lang="zh-CN">

<head>
  
  <title>如何用Cloudflare Worker和Onedrive制作一个简易图床？ - redball&#39;s Blog</title>
  <meta charset="UTF-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  
  

  <link rel="shortcut icon" href="/favicon.ico" type="image/png" />
  <meta name="description" content="前言本站放图片用的图床就是使用这个技术的。 准备材料1.一个永久的Office 365订阅(推荐Enterprice版)2.Cloudflare账号3.一个域名(如果需要的话) 第一部分:创建应用第一步:登录Azure Active Directory admin center第二步:创建应用首先我们进入注册应用程序页面然后点击顶上的新注册，然后名称随便填,受支持的用户类型选第三个，重定向URI填">
<meta property="og:type" content="article">
<meta property="og:title" content="如何用Cloudflare Worker和Onedrive制作一个简易图床？">
<meta property="og:url" content="https://blog.redball1017.ga/2021/04/05/make-pan-with-cloudflare/index.html">
<meta property="og:site_name" content="redball&#39;s Blog">
<meta property="og:description" content="前言本站放图片用的图床就是使用这个技术的。 准备材料1.一个永久的Office 365订阅(推荐Enterprice版)2.Cloudflare账号3.一个域名(如果需要的话) 第一部分:创建应用第一步:登录Azure Active Directory admin center第二步:创建应用首先我们进入注册应用程序页面然后点击顶上的新注册，然后名称随便填,受支持的用户类型选第三个，重定向URI填">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://image.redball1017.cf/make-pan-with-cloudflare/image1.jpg">
<meta property="og:image" content="https://image.redball1017.cf/make-pan-with-cloudflare/image2.jpg">
<meta property="og:image" content="https://image.redball1017.cf/make-pan-with-cloudflare/image3.jpg">
<meta property="og:image" content="https://image.redball1017.cf/make-pan-with-cloudflare/image4.jpg">
<meta property="og:image" content="https://image.redball1017.cf/make-pan-with-cloudflare/image5.jpg">
<meta property="og:image" content="https://image.redball1017.cf/make-pan-with-cloudflare/image6.jpg">
<meta property="og:image" content="https://image.redball1017.cf/make-pan-with-cloudflare/image8.jpg">
<meta property="article:published_time" content="2021-04-05T03:53:01.047Z">
<meta property="article:modified_time" content="2021-04-05T06:09:02.976Z">
<meta property="article:author" content="redball">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.redball1017.cf/make-pan-with-cloudflare/image1.jpg">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,gh/theme-nexmoe/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,gh/theme-nexmoe/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css?v=233" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css">
  
  <link rel="stylesheet" href="/css/style.css?v=1618733028168">
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/nexmoe/nexmoe.github.io@latest/images/cover/5c3aec85a4343.jpg)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="redball" class="mdui-btn mdui-btn-icon"><img src="https://cdn.jsdelivr.net/gh/nexmoe/nexmoe.github.io@latest/images/avatar.png" alt="redball"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="redball">
            <img src="https://cdn.jsdelivr.net/gh/nexmoe/nexmoe.github.io@latest/images/avatar.png" alt="redball" alt="redball">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>4</div>
        <div><span>标签</span>1</div>
        <div><span>分类</span>1</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about.html" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
  
  <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
        <form id="search_form" action_e="https://cn.bing.com/search?q=site:nexmoe.com" onsubmit="return search();">
            <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
        </form>
    </div>
</div>
  
  <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://jq.qq.com/?_wv=1027&k=5CfKHun" target="_blank" mdui-tooltip="{content: 'QQ群'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com/20238211" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/nexmoe/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/资源分享/">资源分享</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/switch/" style="font-size: 10px;">switch</a>
    </div>
    
  </div>

  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2021 redball
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        
    </div>
</div><!-- .nexmoe-drawer -->
  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">

  <div class="nexmoe-post-right">
    
  </div>

  <article>
    
        <div class="nexmoe-post-cover" style="padding-bottom: 66.66666666666666%;"> 
            <img data-src="https://cdn.jsdelivr.net/gh/nexmoe/nexmoe.github.io@latest/images/cover/5c3aec85a4343.jpg" data-sizes="auto" alt="如何用Cloudflare Worker和Onedrive制作一个简易图床？" class="lazyload">
            <h1>如何用Cloudflare Worker和Onedrive制作一个简易图床？</h1>
        </div>
    
    
    <div class="nexmoe-post-meta nexmoe-rainbow-fill" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2021年04月05日</a>
    <a><i class="nexmoefont icon-areachart"></i>2.6k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 15 分钟</a>
</div>

    <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本站放图片用的图床就是使用这个技术的。</p>
<h1 id="准备材料"><a href="#准备材料" class="headerlink" title="准备材料"></a>准备材料</h1><p>1.一个永久的Office 365订阅(推荐Enterprice版)<br>2.Cloudflare账号<br>3.一个域名(如果需要的话)</p>
<h1 id="第一部分-创建应用"><a href="#第一部分-创建应用" class="headerlink" title="第一部分:创建应用"></a>第一部分:创建应用</h1><h2 id="第一步-登录Azure-Active-Directory-admin-center"><a href="#第一步-登录Azure-Active-Directory-admin-center" class="headerlink" title="第一步:登录Azure Active Directory admin center"></a>第一步:登录<a target="_blank" rel="noopener" href="https://aad.portal.azure.com/" title="Azure Active Directory admin center">Azure Active Directory admin center</a></h2><h2 id="第二步-创建应用"><a href="#第二步-创建应用" class="headerlink" title="第二步:创建应用"></a>第二步:创建应用</h2><h4 id="首先我们进入注册应用程序页面"><a href="#首先我们进入注册应用程序页面" class="headerlink" title="首先我们进入注册应用程序页面"></a>首先我们进入<a target="_blank" rel="noopener" href="https://aad.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps" title="注册应用程序页面">注册应用程序页面</a></h4><h4 id="然后点击顶上的新注册，然后名称随便填-受支持的用户类型选第三个，重定向URI填https-heymind-github-io-tools-microsoft-graph-api-auth-然后点击下方的注册"><a href="#然后点击顶上的新注册，然后名称随便填-受支持的用户类型选第三个，重定向URI填https-heymind-github-io-tools-microsoft-graph-api-auth-然后点击下方的注册" class="headerlink" title="然后点击顶上的新注册，然后名称随便填,受支持的用户类型选第三个，重定向URI填https://heymind.github.io/tools/microsoft-graph-api-auth ,然后点击下方的注册"></a>然后点击顶上的新注册，然后名称随便填,受支持的用户类型选第三个，重定向URI填<a target="_blank" rel="noopener" href="https://heymind.github.io/tools/microsoft-graph-api-auth">https://heymind.github.io/tools/microsoft-graph-api-auth</a> ,然后点击下方的注册</h4><p><a target="_blank" rel="noopener" href="https://image.redball1017.cf/make-pan-with-cloudflare/image1.jpg"><img src="https://image.redball1017.cf/make-pan-with-cloudflare/image1.jpg"></a></p>
<h4 id="然后我们要记住我们获取的应用程序-客户端-ID（创建完成后就会显示）和密码"><a href="#然后我们要记住我们获取的应用程序-客户端-ID（创建完成后就会显示）和密码" class="headerlink" title="然后我们要记住我们获取的应用程序(客户端) ID（创建完成后就会显示）和密码"></a>然后我们要记住我们获取的应用程序(客户端) ID（创建完成后就会显示）和密码</h4><h2 id="第三步-获取应用程序-客户端-ID和密码"><a href="#第三步-获取应用程序-客户端-ID和密码" class="headerlink" title="第三步:获取应用程序(客户端) ID和密码"></a>第三步:获取应用程序(客户端) ID和密码</h2><h4 id="应用程序-客户端-ID就在如图所示的地方"><a href="#应用程序-客户端-ID就在如图所示的地方" class="headerlink" title="应用程序(客户端) ID就在如图所示的地方"></a>应用程序(客户端) ID就在如图所示的地方</h4><p><a target="_blank" rel="noopener" href="https://image.redball1017.cf/make-pan-with-cloudflare/image2.jpg"><img src="https://image.redball1017.cf/make-pan-with-cloudflare/image2.jpg"></a></p>
<h4 id="获取密码要先点击左侧列表的证书和密码"><a href="#获取密码要先点击左侧列表的证书和密码" class="headerlink" title="获取密码要先点击左侧列表的证书和密码"></a>获取密码要先点击左侧列表的证书和密码</h4><p><a target="_blank" rel="noopener" href="https://image.redball1017.cf/make-pan-with-cloudflare/image3.jpg"><img src="https://image.redball1017.cf/make-pan-with-cloudflare/image3.jpg"></a></p>
<h4 id="然后点击客户端密码下面的新客户端密码，在弹出的对话框里面的截止日期选择从不，然后点击添加"><a href="#然后点击客户端密码下面的新客户端密码，在弹出的对话框里面的截止日期选择从不，然后点击添加" class="headerlink" title="然后点击客户端密码下面的新客户端密码，在弹出的对话框里面的截止日期选择从不，然后点击添加"></a>然后点击客户端密码下面的新客户端密码，在弹出的对话框里面的截止日期选择从不，然后点击添加</h4><p><a target="_blank" rel="noopener" href="https://image.redball1017.cf/make-pan-with-cloudflare/image4.jpg"><img src="https://image.redball1017.cf/make-pan-with-cloudflare/image4.jpg"></a></p>
<h4 id="然后把值复制一下即可"><a href="#然后把值复制一下即可" class="headerlink" title="然后把值复制一下即可"></a>然后把值复制一下即可</h4><h2 id="第四步获取refresh-token"><a href="#第四步获取refresh-token" class="headerlink" title="第四步获取refresh_token"></a>第四步获取refresh_token</h2><h4 id="首先我们要转到https-heymind-github-io-tools-microsoft-graph-api-auth"><a href="#首先我们要转到https-heymind-github-io-tools-microsoft-graph-api-auth" class="headerlink" title="首先我们要转到https://heymind.github.io/tools/microsoft-graph-api-auth"></a>首先我们要转到<a target="_blank" rel="noopener" href="https://heymind.github.io/tools/microsoft-graph-api-auth">https://heymind.github.io/tools/microsoft-graph-api-auth</a></h4><h4 id="然后把应用ID粘贴到图示的地方，然后点击Authorize，然后登录你的账户，权限代表组织同意"><a href="#然后把应用ID粘贴到图示的地方，然后点击Authorize，然后登录你的账户，权限代表组织同意" class="headerlink" title="然后把应用ID粘贴到图示的地方，然后点击Authorize，然后登录你的账户，权限代表组织同意"></a>然后把应用ID粘贴到图示的地方，然后点击Authorize，然后登录你的账户，权限代表组织同意</h4><p><a target="_blank" rel="noopener" href="https://image.redball1017.cf/make-pan-with-cloudflare/image5.jpg"><img src="https://image.redball1017.cf/make-pan-with-cloudflare/image5.jpg"></a></p>
<h4 id="然后下方Exchange-Access-Token就是refresh-token了"><a href="#然后下方Exchange-Access-Token就是refresh-token了" class="headerlink" title="然后下方Exchange Access Token就是refresh_token了"></a>然后下方Exchange Access Token就是refresh_token了</h4><p><a target="_blank" rel="noopener" href="https://image.redball1017.cf/make-pan-with-cloudflare/image6.jpg"><img src="https://image.redball1017.cf/make-pan-with-cloudflare/image6.jpg"></a></p>
<h1 id="第二部分-用Cloudflare-Worker-搭建一个个人网盘"><a href="#第二部分-用Cloudflare-Worker-搭建一个个人网盘" class="headerlink" title="第二部分:用Cloudflare Worker 搭建一个个人网盘"></a>第二部分:用Cloudflare Worker 搭建一个个人网盘</h1><p>注册Cloudflare账号这里略</p>
<h2 id="第一步-创建Worker"><a href="#第一步-创建Worker" class="headerlink" title="第一步:创建Worker"></a>第一步:创建Worker</h2><h4 id="到网址https-dash-cloudflare-com-workers-overview-，然后点击创建Worker"><a href="#到网址https-dash-cloudflare-com-workers-overview-，然后点击创建Worker" class="headerlink" title="到网址https://dash.cloudflare.com/workers/overview ，然后点击创建Worker"></a>到网址<a target="_blank" rel="noopener" href="https://dash.cloudflare.com/workers/overview">https://dash.cloudflare.com/workers/overview</a> ，然后点击创建Worker</h4><h4 id="然后在右侧代码栏中填入代码-refresh-token填你获取到的refresh-token-client-id-填你获取得到的应用ID，client-seret填你获取到的客户端密码，base填你想要作为网站根目录的路径-格式-路径，如-images"><a href="#然后在右侧代码栏中填入代码-refresh-token填你获取到的refresh-token-client-id-填你获取得到的应用ID，client-seret填你获取到的客户端密码，base填你想要作为网站根目录的路径-格式-路径，如-images" class="headerlink" title="然后在右侧代码栏中填入代码: (refresh_token填你获取到的refresh_token,client_id 填你获取得到的应用ID，client_seret填你获取到的客户端密码，base填你想要作为网站根目录的路径,格式:/路径，如/images)"></a>然后在右侧代码栏中填入代码: (refresh_token填你获取到的refresh_token,client_id 填你获取得到的应用ID，client_seret填你获取到的客户端密码，base填你想要作为网站根目录的路径,格式:/路径，如/images)</h4><pre><code>const config = &#123;
    /**
     * You can use this tool http://heymind.github.io/tools/microsoft-graph-api-auth
     * to get following params: client_id, client_secret, refresh_token &amp; redirect_uri.
     */
    &quot;refresh_token&quot;: &quot;&quot;,
    &quot;client_id&quot;: &quot;&quot;,
    &quot;client_secret&quot;: &quot;&quot;,
    &quot;redirect_uri&quot;: &quot;https://heymind.github.io/tools/microsoft-graph-api-auth&quot;,
    /**
     * The base path for indexing, all files and subfolders are public by this tool. For example `/Share`.
     */
    base: &quot;/&quot;,
    /**
     * Feature Caching
     * Enable Cloudflare cache for path pattern listed below.
     * Cache rules:
     * - Entire File Cache  0 &lt; file_size &lt; entireFileCacheLimit
     * - Chunked Cache     entireFileCacheLimit  &lt;= file_size &lt; chunkedCacheLimit
     * - No Cache ( redirect to OneDrive Server )   others
     * 
     * Difference between `Entire File Cache` and `Chunked Cache`
     * 
     * `Entire File Cache` requires the entire file to be transferred to the Cloudflare server before 
     *  the first byte sent to a client.
     * 
     * `Chunked Cache` would stream the file content to the client while caching it.
     *  But there is no exact Content-Length in the response headers. ( Content-Length: chunked )
     * 
     */
    &quot;cache&quot;: &#123;
        &quot;enable&quot;: false,
        &quot;entireFileCacheLimit&quot;: 10000000, // 10MB
        &quot;chunkedCacheLimit&quot;: 100000000, // 100MB 
        &quot;paths&quot;: [&quot;/Images&quot;]
    &#125;,
    /**
     * Feature Thumbnail
     * Show a thumbnail of image by ?thumbnail=small (small,medium,large)
     * more details: https://docs.microsoft.com/en-us/onedrive/developer/rest-api/api/driveitem_list_thumbnails?view=odsp-graph-online#size-options
     * example: https://storage.idx0.workers.dev/Images/def.png?thumbnail=mediumSquare
     *  
     */
    &quot;thumbnail&quot;: true,
    /**
     * Small File Upload ( &lt;= 4MB )
     * example: POST https://storage.idx0.workers.dev/Images/?upload=&lt;filename&gt;&amp;key=&lt;secret_key&gt;
     */
    &quot;upload&quot;: &#123;
        &quot;enable&quot;: false,
        &quot;key&quot;: &quot;your_secret_1key_here&quot;
    &#125;,
    /**
     * Feature Proxy Download
     * Use Cloudflare as a relay to speed up download. ( especially in Mainland China )
     * example: https://storage.idx0.workers.dev/Images/def.png?proxied
     */
    &quot;proxyDownload&quot;: true,
&#125;;

/**
 * Basic authentication.
 * Disabled by default (Issue #29)
 * 
 * AUTH_ENABLED   to enable auth set true
 * NAME           user name
 * PASS           password
 */
const AUTH_ENABLED = false
const NAME = &quot;admin&quot;
const PASS = &quot;password&quot;

/**
 * RegExp for basic auth credentials
 *
 * credentials = auth-scheme 1*SP token68
 * auth-scheme = &quot;Basic&quot; ; case insensitive
 * token68     = 1*( ALPHA / DIGIT / &quot;-&quot; / &quot;.&quot; / &quot;_&quot; / &quot;~&quot; / &quot;+&quot; / &quot;/&quot; ) *&quot;=&quot;
 */

const CREDENTIALS_REGEXP = /^ *(?:[Bb][Aa][Ss][Ii][Cc]) +([A-Za-z0-9._~+/-]+=*) *$/

/**
 * RegExp for basic auth user/pass
 *
 * user-pass   = userid &quot;:&quot; password
 * userid      = *&lt;TEXT excluding &quot;:&quot;&gt;
 * password    = *TEXT
 */

const USER_PASS_REGEXP = /^([^:]*):(.*)$/

/**
 * Object to represent user credentials.
 */

const Credentials = function(name, pass) &#123;
  this.name = name
  this.pass = pass
&#125;

/**
 * Parse basic auth to object.
 */

const parseAuthHeader = function(string) &#123;
  if (typeof string !== &#39;string&#39;) &#123;
    return undefined
  &#125;

  // parse header
  const match = CREDENTIALS_REGEXP.exec(string)

  if (!match) &#123;
    return undefined
  &#125;

  // decode user pass
  const userPass = USER_PASS_REGEXP.exec(atob(match[1]))

  if (!userPass) &#123;
    return undefined
  &#125;

  // return credentials object
  return new Credentials(userPass[1], userPass[2])
&#125;
</code></pre>
<p>​<br>    const unauthorizedResponse = function(body) {<br>      return new Response(<br>        null, {<br>          status: 401,<br>          statusText: “‘Authentication required.’”,<br>          body: body,<br>          headers: {<br>            “WWW-Authenticate”: ‘Basic realm=”User Visible Realm”‘<br>          }<br>        }<br>      )<br>    }</p>
<pre><code>async function handle(request) &#123;
    if (AUTH_ENABLED == false) &#123;
        return handleRequest(request)
    &#125; else if (AUTH_ENABLED == true) &#123;
        const credentials = parseAuthHeader(request.headers.get(&quot;Authorization&quot;))
        if (!credentials || credentials.name !== NAME || credentials.pass !== PASS) &#123;
            return unauthorizedResponse(&quot;Unauthorized&quot;)
        &#125; else &#123;
            return handleRequest(request)
        &#125;
    &#125; else &#123;
        console.info(&quot;Auth error unexpected.&quot;)
    &#125;
&#125;

addEventListener(&#39;fetch&#39;, event =&gt; &#123;
    event.respondWith(handle(event.request))
&#125;)

/**
 * Current access token 
 */
let _accessToken = null;

/**
 * Cloudflare cache instance
 */
let cache = caches.default;

/**
 * Get access token for microsoft graph API endpoints. Refresh token if needed.
 */
async function getAccessToken() &#123;
    if (_accessToken) return _accessToken;
    resp = await fetch(&quot;https://login.microsoftonline.com/common/oauth2/v2.0/token&quot;, &#123;
        method: &quot;POST&quot;,
        body: `client_id=$&#123;config.client_id&#125;&amp;redirect_uri=$&#123;config.redirect_uri&#125;&amp;client_secret=$&#123;config.client_secret&#125;
    &amp;refresh_token=$&#123;config.refresh_token&#125;&amp;grant_type=refresh_token`,
        headers: &#123;
            &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;
        &#125;
    &#125;);
    if (resp.ok) &#123;
        console.info(&quot;access_token refresh success.&quot;)
        const data = await resp.json()
        _accessToken = data.access_token
        return _accessToken;
    &#125; else throw `getAccessToken error $&#123; JSON.stringify(await resp.text())&#125;`
&#125;
</code></pre>
<p>​<br>​<br>​<br>    /**<br>     * mimetype to Material Icon name<br>     * @param {string} ype<br>     */<br>    function mime2icon(type) {<br>        if (type.startsWith(“image”)) return “image”;<br>        if (type.startsWith(“image”)) return “video_label”;<br>        if (type.startsWith(“image”)) return “audiotrack”;<br>        return “description”;<br>    }</p>
<pre><code>/**
 * Cache downloadUrl according to caching rules.
 * @param &#123;Request&#125; request client&#39;s request 
 * @param &#123;integer&#125; fileSize 
 * @param &#123;string&#125; downloadUrl 
 * @param &#123;function&#125; fallback handle function if the rules is not satisfied
 */
async function setCache(request, fileSize, downloadUrl, fallback) &#123;
    if (fileSize &lt; config.cache.entireFileCacheLimit) &#123;
        console.info(`Cache entire file $&#123;request.url&#125;`);
        const remoteResp = await fetch(downloadUrl);
        const resp = new Response(remoteResp.body, &#123;
            headers: &#123;
                &quot;Content-Type&quot;: remoteResp.headers.get(&quot;Content-Type&quot;),
                &quot;ETag&quot;: remoteResp.headers.get(&quot;ETag&quot;),
            &#125;,
            status: remoteResp.status,
            statusText: remoteResp.statusText,
        &#125;);
        await cache.put(request, resp.clone());
        return resp;

    &#125; else if (fileSize &lt; config.cache.chunkedCacheLimit) &#123;
        console.info(`Chunk cache file $&#123;request.url&#125;`);
        const remoteResp = await fetch(downloadUrl);
        let &#123;
            readable,
            writable
        &#125; = new TransformStream();
        remoteResp.body.pipeTo(writable);
        const resp = new Response(readable, &#123;
            headers: &#123;
                &quot;Content-Type&quot;: remoteResp.headers.get(&quot;Content-Type&quot;),
                &quot;ETag&quot;: remoteResp.headers.get(&quot;ETag&quot;)
            &#125;,
            status: remoteResp.status,
            statusText: remoteResp.statusText
        &#125;);
        await cache.put(request, resp.clone());
        return resp;

    &#125; else &#123;
        console.info(`No cache $&#123;request.url&#125; because file_size($&#123;fileSize&#125;) &gt; limit($&#123;config.cache.chunkedCacheLimit&#125;)`);
        return await fallback(downloadUrl);
    &#125;
&#125;
/**
 * Redirect to the download url.
 * @param &#123;string&#125; downloadUrl 
 */
async function directDownload(downloadUrl) &#123;
    console.info(`DirectDownload -&gt; $&#123;downloadUrl&#125;`);
    return new Response(null, &#123;
        status: 302,
        headers: &#123;
            &quot;Location&quot;: downloadUrl.slice(6)
        &#125;
    &#125;);
&#125;
/**
 * Download a file using Cloudflare as a relay.
 * @param &#123;string&#125; downloadUrl 
 */
async function proxiedDownload(downloadUrl) &#123;
    console.info(`ProxyDownload -&gt; $&#123;downloadUrl&#125;`);
    const remoteResp = await fetch(downloadUrl);
    let &#123;
        readable,
        writable
    &#125; = new TransformStream();
    remoteResp.body.pipeTo(writable);
    return new Response(readable, remoteResp);
&#125;
</code></pre>
<p>​<br>    async function handleFile(request, pathname, downloadUrl, {<br>        proxied = false,<br>        fileSize = 0<br>    }) {<br>        if (config.cache &amp;&amp; config.cache.enable &amp;&amp;<br>            config.cache.paths.filter(p =&gt; pathname.startsWith(p)).length &gt; 0) {<br>            return setCache(request, fileSize, downloadUrl, proxied ? proxiedDownload : directDownload);<br>        }<br>        return (proxied ? proxiedDownload : directDownload)(downloadUrl);<br>    }</p>
<pre><code>async function handleUpload(request, pathname, filename) &#123;
    const url = `https://graph.microsoft.com/v1.0/me/drive/root:$&#123;config.base+(pathname.slice(-1) == &quot;/&quot; ? pathname :pathname + &quot;/&quot;) &#125;$&#123;filename&#125;:/content`;
    return await fetch(url, &#123;
        method: &quot;PUT&quot;,
        headers: &#123;
            &quot;Authorization&quot;: `bearer $&#123;await getAccessToken()&#125;`,
            ...request.headers
        &#125;,
        body: request.body
    &#125;);
&#125;

function wrap_pathname(pathname) &#123;
    pathname = config.base + (pathname == &quot;/&quot; ? &quot;&quot; : pathname);
    return (pathname === &quot;/&quot; || pathname === &quot;&quot;) ? &quot;&quot; : &quot;:&quot; + pathname;
&#125;
</code></pre>
<p>​<br>    async function handleRequest(request) {</p>
<pre><code>    if (config.cache &amp;&amp; config.cache.enable) &#123;
        const maybeResponse = await cache.match(request);
        if (maybeResponse) return maybeResponse;
    &#125;

    const base = config.base;
    const accessToken = await getAccessToken();

    const &#123;
        pathname,
        searchParams
    &#125; = new URL(request.url);

    const thumbnail = config.thumbnail ? searchParams.get(&quot;thumbnail&quot;) : false;
    const proxied = config.proxyDownload ? (searchParams.get(&quot;proxied&quot;) === null ? false : true) : false;
</code></pre>
<p>​<br>        if (thumbnail) {<br>            const url = <code>https://graph.microsoft.com/v1.0/me/drive/root:$&#123;base+(pathname == &quot;/&quot; ? &quot;&quot; :pathname) &#125;:/thumbnails/0/$&#123;thumbnail&#125;/content</code>;<br>            const resp = await fetch(url, {<br>                headers: {<br>                    “Authorization”: <code>bearer $&#123;accessToken&#125;</code><br>                }<br>            });</p>
<pre><code>        return await handleFile(request, pathname, resp.url, &#123;
            proxied
        &#125;);

    &#125;

    const url = `https://graph.microsoft.com/v1.0/me/drive/root$&#123; wrap_pathname(pathname) &#125;?select=name,eTag,size,id,folder,file,%40microsoft.graph.downloadUrl&amp;expand=children(select%3Dname,eTag,size,id,folder,file)`;
    const resp = await fetch(url, &#123;
        headers: &#123;
            &quot;Authorization&quot;: `bearer $&#123;accessToken&#125;`
        &#125;
    &#125;);
    let error = null;
    if (resp.ok) &#123;
        const data = await resp.json();
        if (&quot;file&quot; in data) &#123;
            return await handleFile(request, pathname, data[&quot;@microsoft.graph.downloadUrl&quot;], &#123;
                proxied,
                fileSize: data[&quot;size&quot;]
            &#125;);

        &#125; else if (&quot;folder&quot; in data) &#123;
            if (config.upload &amp;&amp; request.method == &quot;POST&quot;) &#123;
                const filename = searchParams.get(&quot;upload&quot;);
                const key = searchParams.get(&quot;key&quot;);
                if (filename &amp;&amp; key &amp;&amp; config.upload.key == key) &#123;
                    return await handleUpload(request, pathname, filename);
                &#125; else &#123;
                    return new Response(body, &#123;
                        status: 400
                    &#125;);
                &#125;

            &#125;
            if (!request.url.endsWith(&quot;/&quot;)) return Response.redirect(request.url + &quot;/&quot;, 302)
            return new Response(renderFolderIndex(data.children, pathname == &quot;/&quot;), &#123;
                headers: &#123;
                    &#39;Access-Control-Allow-Origin&#39;: &#39;*&#39;,
                    &#39;content-type&#39;: &#39;text/html&#39;
                &#125;
            &#125;);
        &#125; else &#123;
            error = `unknown data $&#123;JSON.stringify(data)&#125;`;
        &#125;
    &#125; else &#123;
        error = (await resp.json()).error;
    &#125;

    if (error) &#123;
        const body = JSON.stringify(error);
        switch (error.code) &#123;
            case &quot;ItemNotFound&quot;:
                return new Response(body, &#123;
                    status: 404,
                    headers: &#123;
                        &#39;content-type&#39;: &#39;application/json&#39;
                    &#125;
                &#125;);
            default:
                return new Response(body, &#123;
                    status: 500,
                    headers: &#123;
                        &#39;content-type&#39;: &#39;application/json&#39;
                    &#125;
                &#125;);
        &#125;

    &#125;
&#125;
/**
 * Render Folder Index
 * @param &#123;*&#125; items 
 * @param &#123;*&#125; isIndex don&#39;t show &quot;..&quot; on index page.
 */
function renderFolderIndex(items, isIndex) &#123;
    const nav = `&lt;nav&gt;&lt;a class=&quot;brand&quot;&gt;OneDrive Index&lt;/a&gt;&lt;/nav&gt;`;
    const el = (tag, attrs, content) =&gt; `&lt;$&#123;tag&#125; $&#123;attrs.join(&quot; &quot;)&#125;&gt;$&#123;content&#125;&lt;/$&#123;tag&#125;&gt;`;
    const div = (className, content) =&gt; el(&quot;div&quot;, [`class=$&#123;className&#125;`], content);
    const item = (icon, filename, size) =&gt; el(&quot;a&quot;, [`href=&quot;$&#123;filename&#125;&quot;`, `class=&quot;item&quot;`, size ? `size=&quot;$&#123;size&#125;&quot;` : &quot;&quot;], el(&quot;i&quot;, [`class=&quot;material-icons&quot;`], icon) + filename)

    return renderHTML(nav + div(&quot;container&quot;, div(&quot;items&quot;, el(&quot;div&quot;, [&#39;style=&quot;min-width:600px&quot;&#39;],
        (!isIndex ? item(&quot;folder&quot;, &quot;..&quot;) : &quot;&quot;) +
        items.map((i) =&gt; &#123;
            if (&quot;folder&quot; in i) &#123;
                return item(&quot;folder&quot;, i.name, i.size)
            &#125; else if (&quot;file&quot; in i) &#123;
                return item(mime2icon(i.file.mimeType), i.name, i.size)
            &#125; else console.log(`unknown item type $&#123;i&#125;`)
        &#125;).join(&quot;&quot;)
    ))));
&#125;
</code></pre>
<p>​<br>​<br>    function renderHTML(body) {<br>        return <code>&lt;!DOCTYPE html&gt;       &lt;html lang=&quot;en&quot;&gt;         &lt;head&gt;           &lt;meta charset=&quot;utf-8&quot; /&gt;           &lt;meta http-equiv=&quot;x-ua-compatible&quot; content=&quot;ie=edge, chrome=1&quot; /&gt;           &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, maximum-scale=1&quot;&gt;           &lt;title&gt;OneDrive Index&lt;/title&gt;           &lt;link href=&#39;https://fonts.loli.net/icon?family=Material+Icons&#39; rel=&#39;stylesheet&#39;&gt;           &lt;link href=&#39;https://cdn.jsdelivr.net/gh/heymind/OneDrive-Index-Cloudflare-Worker/themes/material.css&#39; rel=&#39;stylesheet&#39;&gt;           &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/prismjs@1.17.1/themes/prism-solarizedlight.css&quot;&gt;           &lt;script type=&quot;module&quot; src=&#39;https://cdn.jsdelivr.net/gh/heymind/OneDrive-Index-Cloudflare-Worker/script.js&#39;&gt;&lt;/script＞         &lt;/head&gt;         &lt;body&gt;           $&#123;body&#125;           &lt;div style=&quot;flex-grow:1&quot;&gt;&lt;/div&gt;           &lt;footer&gt;&lt;p&gt;Powered by &lt;a href=&quot;https://github.com/heymind/OneDrive-Index-Cloudflare-Worker&quot;&gt;OneDrive-Index-CF&lt;/a&gt;, hosted on &lt;a href=&quot;https://www.cloudflare.com/products/cloudflare-workers/&quot;&gt;Cloudflare Workers&lt;/a&gt;.&lt;/p&gt;&lt;/footer&gt;           &lt;script src=&quot;https://cdn.jsdelivr.net/npm/prismjs@1.17.1/prism.min.js&quot; data-manual&gt;&lt;/script＞           &lt;script src=&quot;https://cdn.jsdelivr.net/npm/prismjs@1.17.1/plugins/autoloader/prism-autoloader.min.js&quot;&gt;&lt;/script＞         &lt;/body&gt;       &lt;/html&gt;</code><br>    }</p>
<h4 id="然后点击保存并部署即可-网址为弹窗中的网址"><a href="#然后点击保存并部署即可-网址为弹窗中的网址" class="headerlink" title="然后点击保存并部署即可.网址为弹窗中的网址"></a>然后点击保存并部署即可.网址为弹窗中的网址</h4><p><a target="_blank" rel="noopener" href="https://image.redball1017.cf/make-pan-with-cloudflare/image8.jpg"><img src="https://image.redball1017.cf/make-pan-with-cloudflare/image8.jpg"></a></p>
<h2 id="那么教程就到这里结束了，如果喜欢本博客所发布的内容的话请捐赠我，我们有缘再见"><a href="#那么教程就到这里结束了，如果喜欢本博客所发布的内容的话请捐赠我，我们有缘再见" class="headerlink" title="那么教程就到这里结束了，如果喜欢本博客所发布的内容的话请捐赠我，我们有缘再见~"></a>那么教程就到这里结束了，如果喜欢本博客所发布的内容的话请捐赠我，我们有缘再见~</h2>
  </article>

  
    
  <div class="nexmoe-post-copyright">
    <strong>本文作者：</strong>redball<br>
    <strong>本文链接：</strong><a href="https://blog.redball1017.ga/2021/04/05/make-pan-with-cloudflare/" title="https:&#x2F;&#x2F;blog.redball1017.ga&#x2F;2021&#x2F;04&#x2F;05&#x2F;make-pan-with-cloudflare&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;blog.redball1017.ga&#x2F;2021&#x2F;04&#x2F;05&#x2F;make-pan-with-cloudflare&#x2F;</a><br>
    
      <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
    
  </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
    
</div>

  <div class="nexmoe-post-footer">
    <section class="nexmoe-comment">
    <div id="gitment"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
    owner: 'redball1017', // 你的 GitHub ID
    repo: 'redball1017.github.io', // 存储评论的 repo
    oauth: {
        client_id: '5e974a5728f1f0e99045', // 你的 client ID
        client_secret: 'f4b2376ab22388a41a5aa42d5b5606afb458057c' // 你的 client secret
    },
})
gitment.render('gitment')
</script>
</section>
  </div>
</div>
        <!--<div class="nexmoe-post-right">
          <div class="nexmoe-fixed">
            <div class="nexmoe-tool">
              <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
            </div>
          </div>
        </div>-->
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,gh/highlightjs/cdn-release@9.15.8/build/highlight.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script>
	hljs.initHighlightingOnLoad();
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>


<script src="https://cdn.jsdelivr.net/gh/xtaodada/xtaodada.github.io@0.0.2/copy.js"></script>
 

<script src="/js/app.js?v=1618733028173"></script>

<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>

  





</body>

</html>
